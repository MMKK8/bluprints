blueprint:
  name: IKEA SOMRIG (ZHA) - Control de Iluminación
  description: >
    Control integral para el botón IKEA SOMRIG (E2213) usando ZHA.
    - Botón Arriba: Encender (corto), Subir brillo (largo).
    - Botón Abajo: Apagar (corto), Bajar brillo (largo).
  domain: automation
  input:
    somrig_device:
      name: Dispositivo SOMRIG
      description: Selecciona el mando IKEA SOMRIG.
      selector:
        device:
          model: SOMRIG shortcut button
          integration: zha
    target_light:
      name: Luz / Grupo de luces
      description: Entidad de iluminación a controlar.
      selector:
        target:
          entity:
            domain: light
    dim_speed:
      name: Velocidad de regulación
      description: Tiempo entre pasos de brillo (ms).
      default: 500
      selector:
        number:
          min: 100
          max: 2000
          unit_of_measurement: ms

mode: restart
max_exceeded: silent

trigger:
  - platform: event
    event_type: zha_event
    event_data:
      device_id: !input somrig_device

action:
  - variables:
      command: "{{ trigger.event.data.command }}"
      cluster: "{{ trigger.event.data.cluster_id }}"
      # El SOMRIG envía argumentos en una lista [step_mode, step_size, transition_time]
      args: "{{ trigger.event.data.args }}"

  - choose:
      # --- BOTÓN ARRIBA (Puntos): Encender ---
      - conditions:
          - "{{ command == 'on' }}"
          - "{{ cluster == 6 }}"
        sequence:
          - service: light.turn_on
            target: !input target_light

      # --- BOTÓN ARRIBA: Subir Brillo (Pulsación larga) ---
      # args[0] == 0 significa 'Up'
      - conditions:
          - "{{ command == 'step' }}"
          - "{{ cluster == 8 }}"
          - "{{ args[0] == 0 }}"
        sequence:
          - repeat:
              while:
                - condition: template
                  value_template: "true"
              sequence:
                - service: light.turn_on
                  target: !input target_light
                  data:
                    brightness_step_pct: 10
                - delay:
                    milliseconds: !input dim_speed

      # --- BOTÓN ABAJO (Círculo): Apagar ---
      - conditions:
          - "{{ command == 'off' }}"
          - "{{ cluster == 6 }}"
        sequence:
          - service: light.turn_off
            target: !input target_light

      # --- BOTÓN ABAJO: Bajar Brillo (Pulsación larga) ---
      # args[0] == 1 significa 'Down'
      - conditions:
          - "{{ command == 'step' }}"
          - "{{ cluster == 8 }}"
          - "{{ args[0] == 1 }}"
        sequence:
          - repeat:
              while:
                - condition: template
                  value_template: "true"
              sequence:
                - service: light.turn_on
                  target: !input target_light
                  data:
                    brightness_step_pct: -10
                - delay:
                    milliseconds: !input dim_speed

      # --- PARAR ACCIÓN (Al soltar cualquier botón) ---
      - conditions:
          - "{{ command == 'stop' }}"
          - "{{ cluster == 8 }}"
        sequence:
          - stop: "Botón soltado, deteniendo bucle de brillo"

    default: []
